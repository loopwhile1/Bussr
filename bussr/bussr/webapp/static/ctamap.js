// custom info window
eval( function(p, a, c, k, e, r) {
	e = function(c) {
		return (c < a ? '' : e(parseInt(c / a))) + (( c = c % a) > 35 ? String.fromCharCode(c + 29) : c.toString(36))
	};
	if(!''.replace(/^/, String)) {
		while(c--)
		r[e(c)] = k[c] || e(c);
		k = [
		function(e) {
			return r[e]
		}];

		e = function() {
			return '\\w+'
		};
		c = 1
	};
	while(c--)
	if(k[c])
		p = p.replace(new RegExp('\\b' + e(c) + '\\b', 'g'), k[c]);
	return p
}('6 8(a){a=a||{};9.p.1O.2h(2,33);2.M=a.1s||"";2.1A=a.1n||G;2.Y=a.1F||0;2.E=a.1y||1e 9.p.1V(0,0);2.z=a.X||1e 9.p.2x(0,0);2.T=a.S||t;2.1k=a.1j||"2d";2.1i=a.D||{};2.1C=a.1B||"35";2.K=a.1g||"31://2W.9.2Q/2J/2I/2G/1v.2D";3(a.1g===""){2.K=""}2.17=a.1x||1e 9.p.1V(1,1);2.V=a.1o||G;2.16=a.1m||G;2.1J=a.2j||"2g";2.14=a.1q||G;2.4=t;2.w=t;2.P=t;2.O=t;2.B=t;2.N=t}8.q=1e 9.p.1O();8.q.24=6(){5 i;5 f;5 a;5 d=2;5 c=6(e){e.21=Z;3(e.15){e.15()}};5 b=6(e){e.2Z=G;3(e.1Y){e.1Y()}3(!d.14){c(e)}};3(!2.4){2.4=1f.2P("2M");2.1d();3(s 2.M.1r==="r"){2.4.L=2.F()+2.M}v{2.4.L=2.F();2.4.1a(2.M)}2.2C()[2.1J].1a(2.4);2.1z();3(2.4.7.C){2.N=Z}v{3(2.Y!==0&&2.4.W>2.Y){2.4.7.C=2.Y;2.4.7.2z="2w";2.N=Z}v{a=2.1N();2.4.7.C=(2.4.W-a.Q-a.13)+"12";2.N=G}}2.1p(2.1A);3(!2.14){2.B=[];f=["2p","1L","2o","2n","1K","2m","2l","2k","2i"];1l(i=0;i<f.1I;i++){2.B.1H(9.p.u.19(2.4,f[i],c))}2.B.1H(9.p.u.19(2.4,"1L",6(e){2.7.1G="2f"}))}2.O=9.p.u.19(2.4,"2e",b);9.p.u.R(2,"2c")}};8.q.F=6(){5 a="";3(2.K!==""){a="<2b";a+=" 2a=\'"+2.K+"\'";a+=" 29=13";a+=" 7=\'";a+=" X: 28;";a+=" 1G: 27;";a+=" 26: "+2.1C+";";a+="\'>"}J a};8.q.1z=6(){5 a;3(2.K!==""){a=2.4.3d;2.w=9.p.u.19(a,\'1K\',2.25())}v{2.w=t}};8.q.25=6(){5 a=2;J 6(e){e.21=Z;3(e.15){e.15()}9.p.u.R(a,"3c");a.1v()}};8.q.1p=6(d){5 m;5 n;5 e=0,H=0;3(!d){m=2.3a();3(m 39 9.p.38){3(!m.23().37(2.z)){m.36(2.z)}n=m.23();5 a=m.34();5 h=a.W;5 f=a.22;5 k=2.E.C;5 l=2.E.1h;5 g=2.4.W;5 b=2.4.22;5 i=2.17.C;5 j=2.17.1h;5 o=2.20().32(2.z);3(o.x<(-k+i)){e=o.x+k-i}v 3((o.x+g+k+i)>h){e=o.x+g+k+i-h}3(2.16){3(o.y<(-l+j+b)){H=o.y+l-j-b}v 3((o.y+l+j)>f){H=o.y+l+j-f}}v{3(o.y<(-l+j)){H=o.y+l-j}v 3((o.y+b+l+j)>f){H=o.y+b+l+j-f}}3(!(e===0&&H===0)){5 c=m.30();m.2Y(e,H)}}}};8.q.1d=6(){5 i,D;3(2.4){2.4.2X=2.1k;2.4.7.2V="";D=2.1i;1l(i 2U D){3(D.2R(i)){2.4.7[i]=D[i]}}3(s 2.4.7.18!=="r"&&2.4.7.18!==""){2.4.7.2O="2N(18="+(2.4.7.18*2L)+")"}2.4.7.X="2K";2.4.7.11=\'1u\';3(2.T!==t){2.4.7.S=2.T}}};8.q.1N=6(){5 c;5 a={1c:0,1b:0,Q:0,13:0};5 b=2.4;3(1f.1t&&1f.1t.1W){c=b.2H.1t.1W(b,"");3(c){a.1c=A(c.1U,10)||0;a.1b=A(c.1T,10)||0;a.Q=A(c.1X,10)||0;a.13=A(c.1S,10)||0}}v 3(1f.2F.I){3(b.I){a.1c=A(b.I.1U,10)||0;a.1b=A(b.I.1T,10)||0;a.Q=A(b.I.1X,10)||0;a.13=A(b.I.1S,10)||0}}J a};8.q.2E=6(){3(2.4){2.4.2S.2T(2.4);2.4=t}};8.q.1E=6(){2.24();5 a=2.20().2B(2.z);2.4.7.Q=(a.x+2.E.C)+"12";3(2.16){2.4.7.1b=-(a.y+2.E.1h)+"12"}v{2.4.7.1c=(a.y+2.E.1h)+"12"}3(2.V){2.4.7.11=\'1u\'}v{2.4.7.11="1R"}};8.q.2A=6(a){3(s a.1j!=="r"){2.1k=a.1j;2.1d()}3(s a.D!=="r"){2.1i=a.D;2.1d()}3(s a.1s!=="r"){2.1Q(a.1s)}3(s a.1n!=="r"){2.1A=a.1n}3(s a.1F!=="r"){2.Y=a.1F}3(s a.1y!=="r"){2.E=a.1y}3(s a.1m!=="r"){2.16=a.1m}3(s a.X!=="r"){2.1w(a.X)}3(s a.S!=="r"){2.1P(a.S)}3(s a.1B!=="r"){2.1C=a.1B}3(s a.1g!=="r"){2.K=a.1g}3(s a.1x!=="r"){2.17=a.1x}3(s a.1o!=="r"){2.V=a.1o}3(s a.1q!=="r"){2.14=a.1q}3(2.4){2.1E()}};8.q.1Q=6(a){2.M=a;3(2.4){3(2.w){9.p.u.U(2.w);2.w=t}3(!2.N){2.4.7.C=""}3(s a.1r==="r"){2.4.L=2.F()+a}v{2.4.L=2.F();2.4.1a(a)}3(!2.N){2.4.7.C=2.4.W+"12";3(s a.1r==="r"){2.4.L=2.F()+a}v{2.4.L=2.F();2.4.1a(a)}}2.1z()}9.p.u.R(2,"2y")};8.q.1w=6(a){2.z=a;3(2.4){2.1E()}9.p.u.R(2,"1Z")};8.q.1P=6(a){2.T=a;3(2.4){2.4.7.S=a}9.p.u.R(2,"2v")};8.q.2u=6(){J 2.M};8.q.1D=6(){J 2.z};8.q.2t=6(){J 2.T};8.q.2s=6(){2.V=G;3(2.4){2.4.7.11="1R"}};8.q.2r=6(){2.V=Z;3(2.4){2.4.7.11="1u"}};8.q.2q=6(c,b){5 a=2;3(b){2.z=b.1D();2.P=9.p.u.3b(b,"1Z",6(){a.1w(2.1D())})}2.1M(c);3(2.4){2.1p()}};8.q.1v=6(){5 i;3(2.w){9.p.u.U(2.w);2.w=t}3(2.B){1l(i=0;i<2.B.1I;i++){9.p.u.U(2.B[i])}2.B=t}3(2.P){9.p.u.U(2.P);2.P=t}3(2.O){9.p.u.U(2.O);2.O=t}2.1M(t)};', 62, 200, '||this|if|div_|var|function|style|InfoBox|google||||||||||||||||maps|prototype|undefined|typeof|null|event|else|closeListener_|||position_|parseInt|eventListeners_|width|boxStyle|pixelOffset_|getCloseBoxImg_|false|yOffset|currentStyle|return|closeBoxURL_|innerHTML|content_|fixedWidthSet_|contextListener_|moveListener_|left|trigger|zIndex|zIndex_|removeListener|isHidden_|offsetWidth|position|maxWidth_|true||visibility|px|right|enableEventPropagation_|stopPropagation|alignBottom_|infoBoxClearance_|opacity|addDomListener|appendChild|bottom|top|setBoxStyle_|new|document|closeBoxURL|height|boxStyle_|boxClass|boxClass_|for|alignBottom|disableAutoPan|isHidden|panBox_|enableEventPropagation|nodeType|content|defaultView|hidden|close|setPosition|infoBoxClearance|pixelOffset|addClickHandler_|disableAutoPan_|closeBoxMargin|closeBoxMargin_|getPosition|draw|maxWidth|cursor|push|length|pane_|click|mouseover|setMap|getBoxWidths_|OverlayView|setZIndex|setContent|visible|borderRightWidth|borderBottomWidth|borderTopWidth|Size|getComputedStyle|borderLeftWidth|preventDefault|position_changed|getProjection|cancelBubble|offsetHeight|getBounds|createInfoBoxDiv_|getCloseClickHandler_|margin|pointer|relative|align|src|img|domready|infoBox|contextmenu|default|floatPane|apply|touchmove|pane|touchend|touchstart|dblclick|mouseup|mouseout|mousedown|open|hide|show|getZIndex|getContent|zindex_changed|auto|LatLng|content_changed|overflow|setOptions|fromLatLngToDivPixel|getPanes|gif|onRemove|documentElement|mapfiles|ownerDocument|en_us|intl|absolute|100|div|alpha|filter|createElement|com|hasOwnProperty|parentNode|removeChild|in|cssText|www|className|panBy|returnValue|getCenter|http|fromLatLngToContainerPixel|arguments|getDiv|2px|setCenter|contains|Map|instanceof|getMap|addListener|closeclick|firstChild'.split('|'), 0, {}))

var BusStopFetcher = function(resultHandler) {
	return {
		ajaxObj : null,

		// get fetch url
		getStopUrl : function(lat, lng) {
			return '/ws/stops/' + lat + ',' + lng + '/';
		},
		getStopUrlForRect : function(lat1, lng1, lat2, lng2) {
			return '/ws/stopsrect/' + Math.min(lat1, lat2) + ',' + Math.min(lng1, lng2) + '/' + Math.max(lat1, lat2) + ',' + Math.max(lng1, lng2) + '/';
		},
		// abort the pending ajax operation
		abortAjax : function() {
			if(this.ajaxObj) {
				this.ajaxObj.abort();
			}
		},
		getStopsForLatLng : function(lat, lng) {
			var url = this.getStopUrl(lat, lng);
			this.abortAjax();
			this.ajaxObj = $.ajax({
				url : url,
				type : "GET",
				dataType : "json"
			});

			this.ajaxObj.done(function(msg) {
				if(resultHandler && resultHandler.stopFetcherGotStops) {
					resultHandler.stopFetcherGotStops(msg["stops"]);
				}
			});

			this.ajaxObj.fail(function(jqXHR, textStatus) {
				// TODO: handle error
				console.log('ajax failed', jqXHR, textStatus);
			});
		},
		getStopsForRect : function(lat1, lng1, lat2, lng2) {
			var url = this.getStopUrlForRect(lat1, lng1, lat2, lng2);
			this.abortAjax();
			this.ajaxObj = $.ajax({
				url : url,
				type : "GET",
				dataType : "json"
			});

			this.ajaxObj.done(function(msg) {
				if(resultHandler && resultHandler.stopFetcherGotStops) {
					resultHandler.stopFetcherGotStops(msg["stops"]);
				}
			});

			this.ajaxObj.fail(function(jqXHR, textStatus) {
				// TODO: handle error
				console.log('ajax failed', jqXHR, textStatus);
			});
		}
	}
};
var BubbleContentFetcher = function(resultHandler) {
	return {
		ajaxObj : null,

		// get fetch url
		getStopUrl : function(stop) {
			return '/agency/' + stop.agencyId + '/bubble/' + stop.stopId + '/';
		},
		// abort the pending ajax operation
		abortAjax : function() {
			if(this.ajaxObj) {
				this.ajaxObj.abort();
			}
		},
		getBubbleContent : function(stop) {
			var url = this.getStopUrl(stop);
			this.abortAjax();

			this.ajaxObj = $.ajax({
				url : url,
				type : "GET",
				dataType : "html"
			});

			this.ajaxObj.done(function(msg) {
				console.log(msg);
				if(resultHandler && resultHandler.bubbleContentFetcherGotContent) {
					resultHandler.bubbleContentFetcherGotContent(msg);
				}
			});

			this.ajaxObj.fail(function(jqXHR, textStatus) {
				// TODO: handle error
				console.log('ajax failed', jqXHR, textStatus);
			});
		}
	}
};
var MarkerManager = function(googleMapObj, markerDelegate) {
	return {
		activeMarkers : [], // stopId -> annotation
		activeStopIds : {}, // stopId's current visible stopId - ''

		//+----------------------------------------------------------------
		// Add a marker to the map.
		// Add a click event to the marker to
		// display a bubble.
		//-----------------------------------------------------------------
		addMarker : function(stop) {
			var stopId = stop.stopId;
			var mapMarker;
			var marker;
			var lat, lng;
			var position;

			if(this.activeMarkers[stopId] === undefined) {
				lat = parseFloat(stop["lat"]);
				lng = parseFloat(stop["lng"]);
				position = new google.maps.LatLng(lat, lng);
				marker = new google.maps.Marker({
					position : position,
					map : googleMapObj,
					draggable : false,
					clickable : true
				});

				// add a marker to the map. also add it to our ivar set
				mapMarker = this.activeMarkers[stopId] = {
					'stopId' : stopId,
					'lat' : lat,
					'lng' : lng,
					'stop' : stop,
					'marker' : marker
				};

				// display the bubble on click
				google.maps.event.addListener(marker, 'click', function() {
					markerDelegate.displayBubble(mapMarker);
				});
			}
		},
		//+----------------------------------------------------------------
		// Delete a marker from the map and our local set
		//-----------------------------------------------------------------
		deleteMarker : function(stopId) {
			if(this.activeMarkers[stopId]) {
				if(this.activeMarkers[stopId].marker) {
					this.activeMarkers[stopId].marker.setMap(null);
				}

				this.activeMarkers[stopId] = null;
				delete this.activeMarkers[stopId];
			}
		},
		updateMarkersWithStops : function(newStops) {
			// start with deleting all stops
			var stopIdsToDelete = this.clone(this.activeStopIds);
			this.activeStopIds = {}

			for(var i in newStops) {
				stop = newStops[i];
				stopId = stop.stopId;
				this.activeStopIds[stopId] = '';
				if(stopIdsToDelete[stopId] !== undefined) {
					delete stopIdsToDelete[stopId];
				}
			}

			for(stopId in stopIdsToDelete) {
				this.deleteMarker(stopId);
			}

			for(var j = 0; j < newStops.length; j++) {
				stop = newStops[j];
				this.addMarker(stop);
			}
		},
		clone : function(obj) {
			return jQuery.extend(true, {}, obj);
		},
	}
};
var earthQuakeMap = {
	map : null, // google map object
	busStopFetcher : null, // ajax fetcher
	searchDelay : null, // delay the search, prevent overzealous searching
	viewport : {
		x : 0,
		y : 0
	}, // holds viewport dimensions
	markerManager : null, // marker manager
	infoWindow : null, // ivar to the visible bubble
	bubbleContentFetcher : null, // ajax bubble content fetcher
	currentLocationMarker : null, // marker displays users current location

	// resizes map div and triggers the Google Map API's resize event
	resizeMap : function(mapDivId) {
		var that = this;
		google.maps.event.trigger(that.mapObj, 'resize');
	},
	stopFetcherGotStops : function(stops) {
		this.markerManager.updateMarkersWithStops(stops);
	},
	searchAroundMapCenter : function() {
		this.searchForStopsAroundCenter(this.map.getCenter());
	},
	searchMapBounds : function() {
		bounds = this.map.getBounds();
		this.searchMapBoundsHelper(bounds.getNorthEast(), bounds.getSouthWest());
	},
	searchMapBoundsHelper : function(corner1, corner2) {
		this.busStopFetcher.getStopsForRect(corner1.lat(), corner1.lng(), corner2.lat(), corner2.lng());
	},
	searchForStopsAroundCenter : function(center) {
		this.busStopFetcher.getStopsForLatLng(center.lat(), center.lng());
	},
	initializeGoogleMapHelper : function(bounds) {
		var that = this;
		var initialMapCenter = new google.maps.LatLng(41.87811, -87.62980);
		var myOptions = {
			zoom: 18,
			center: initialMapCenter,
			mapTypeId : google.maps.MapTypeId.ROADMAP
		};

		this.map = new google.maps.Map(document.getElementById('map_canvas'), myOptions);

		if(bounds) {
			this.map.fitBounds(bounds);
		}

		var that = this;

		google.maps.event.addListener(this.map, 'bounds_changed', function() {
			that.handleBoundsChanged();
		});

		google.maps.event.addListener(this.map, 'dragstart', function() {
			that.handleDragStart();
		});
		
		google.maps.event.addListener(this.map, 'zoom_changed', function() {
			that.handleZoomChanged();
		});
		
		google.maps.event.addListener(this.map, 'idle', function() {
			that.handleMapIdle();
		});
		
		google.maps.event.addListener(this.map, 'click', function() {
			that.handleMapClick();
		});
	},
		
	initializeMap : function(bounds) {
		// Create the bus stop fetcher with ourselves as the delegate
		this.busStopFetcher = BusStopFetcher(earthQuakeMap);
		this.bubbleContentFetcher = BubbleContentFetcher(earthQuakeMap);
		this.initializeGoogleMapHelper(bounds);
		this.markerManager = MarkerManager(this.map, earthQuakeMap);
	},
	bubbleContentFetcherGotContent : function(content) {
		this.infoWindow.setContent(content);
	},
	closeBubble : function() {
		if(this.infoWindow) {
			this.infoWindow.close();
		}
		this.infoWindow = null;
	},
	displayBubble : function(marker) {
		// $.mobile.changePage('/stop/'+marker.stop.stopId+'/', {reloadPage:true});
		this.closeBubble();

		/*
		 this.infoWindow = new google.maps.InfoWindow({
		 content: 'Loading...'
		 });
		 this.infoWindow.open(this.map, marker.marker);
		 */
		var boxText = document.createElement("div");
		boxText.style.cssText = "border: 1px solid black; margin-top: 8px; background: white; padding: 5px;";
		boxText.innerHTML = "Loading...";

		var myOptions = {
			content : boxText,
			disableAutoPan : false,
			maxWidth : 0,
			pixelOffset : new google.maps.Size(-140, 0),
			zIndex : null,
			boxStyle : {
				background : "url('/static/tipbox.gif') no-repeat",
				opacity : 0.95,
				width : "280px"
			},
			closeBoxMargin : "10px 2px 2px 2px",
			closeBoxURL : "http://www.google.com/intl/en_us/mapfiles/close.gif",
			infoBoxClearance : new google.maps.Size(1, 1),
			isHidden : false,
			pane : "floatPane",
			enableEventPropagation : false
		};
		this.infoWindow = new InfoBox(myOptions);
		this.infoWindow.open(this.map, marker.marker);
		this.bubbleContentFetcher.getBubbleContent(marker.stop);
	},
	// Private methods
	// Abort the pending ajax fetch
	abortPendingFetch : function() {
		if(this.busStopFetcher) {
			this.busStopFetcher.abortAjax();
		}
	},
	//+-----------------------------------------------------------
	// event handlers
	//------------------------------------------------------------
	/**
	 * Map bounds changed
	 */
	handleBoundsChanged : function() {
		if(this.searchTimeout) {
			clearTimeout(this.searchTimeout);
		}

		var bounds = this.map.getBounds();
		MobileUtilities.setCookiedMapBounds(bounds);

		var that = this;
		this.searchTimeout = setTimeout(function() {
			that.searchMapBounds();
		}, 500);
	},
	
	/**
	 * Handle the dragging of the map
	 */
	handleDragStart : function() {
		this.abortPendingFetch();
		//		this.abortResultHandler();
		//		this.hideMarkers();
		//		this.hideBubble();
		//		this.changeStatus( "Loading...", true );
	},
	
	/**
	 * google map zoom changed
	 */
	handleZoomChanged : function() {
		
	},
	
	/**
	 * google map idled
	 */
	handleMapIdle : function() {
		
	},
	
	/**
	 * google map was clicked
	 */
	handleMapClick : function() {
		
	},
	
	//+-------------------------------------------------------------
	// Current location methods
	//--------------------------------------------------------------

	/* Locates a user, if it finds a location */
	locate : function() {
		var that = this;
		if (navigator.geolocation)
		{
			navigator.geolocation.getCurrentPosition(
				// success callback
				function(position) {
					that.foundLocationCallback(position);
				},
				
				// fail callback
				function(e) {
					that.locationLookupFailed(e);
				}
			);
		}
	},
	
	/**
	 * Place the current location icon
	 */
	placeCurrentLocationMarker : function(lat, lng) {
		lat = parseFloat(lat);
		lng = parseFloat(lng);
		if(MobileUtilities.isLat(lat) && MobileUtilities.isLng(lng)) {
			// Delete existing from the map
			if(this.currentLocationMarker) {
				this.currentLocationMarker.setMap(null);
			}

			// Create a new marker and add it to the map
			var gMarker = new google.maps.LatLng(lat, lng);
			var gMarkerOptions = {
				clickable : false,
				icon : '/static/gps.png',
				map : this.map,
				position : gMarker
			};
			this.currentLocationMarker = new google.maps.Marker(gMarkerOptions);
		}
	},
	
	/**
	 * Couldn't determine user location.
	 */
	locationLookupFailed : function(error) {
		alert("Cannot find your location " + e);
	},
	

	/**
	 * User location found
	 */
	foundLocationCallback : function(position) {
		this.placeCurrentLocationMarker(position.coords.latitude, position.coords.longitude);
	},

};

/* Mobile utilities */
var MobileUtilities = {
	/**
	 * Verify the latitude passed in is valid
	 */
	isLat : function(lat) {
		return lat <= 90 && lat >= -90 ? true : false;
	},
	
	/**
	 * Verify the longitude is valid
	 */
	isLng : function(lon) {
		return lon <= 180 && lon >= -180 ? true : false;
	},
	
	/**
	 * Read the cookied map rect and returns a google latlngbounds object. Return undefined
	 * if there is no cookie
	 */
	cookiedMapBounds : function() {
		var rect = $.cookie('map_rect');
		var bounds = undefined;
		if (rect) {
			coords = rect.split(',');
			//TODO: validate
			var southWest = new google.maps.LatLng(coords[0], coords[1]);
			var northEast = new google.maps.LatLng(coords[2], coords[3]);
			bounds = new google.maps.LatLngBounds(southWest, northEast);
		}
		return bounds;
	},
	
	/**
	 * set the map bounds cookie
	 */
	setCookiedMapBounds : function(gLatLngBounds) {
		$.cookie('map_rect', gLatLngBounds.toUrlValue());
	},
	
	// TODO: Implement me
	cookiedUserLocation : function() {
		
	},
	
	// TODO: Implement me
	setCookiedUserLocation : function(lat, lng) {
		
	}
};

// When the document is ready initialize the map.
$(document).ready(function() {
	// Try to get previous map location from the cookie
	var bounds = MobileUtilities.cookiedMapBounds();
	
	// Initialize the google map with the cookied bounds
	earthQuakeMap.initializeMap(bounds);
	
	// var mapDivId = 'map_canvas';
	// earthQuakeMap.resizeMap(mapDivId);

	// Trigger the resize event
	$(window).resize(function() {
		var mapDivId = 'map_canvas';
		earthQuakeMap.resizeMap(mapDivId);
	});

	// Hookup the GPS event
	$("#gps_button").click(function(event) {
		event.preventDefault();
		earthQuakeMap.locate();
	});
});
